<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptaShare - Secure, Serverless File Sharing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- QR Code Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <!-- QR Code Scanning Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
        }
        .hero-gradient {
            background: radial-gradient(ellipse 80% 50% at 50% -20%,rgba(59,130,246,.3),hsla(0,0%,100%,0));
        }
        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px dashed #4a5568;
            border-radius: 0.5rem;
            padding: 2rem;
            transition: all 0.2s ease-in-out;
        }
        .file-input-label:hover {
            border-color: #718096;
            background-color: #2d3748;
        }
        .file-input-label.dragover {
            border-color: #4299e1;
            background-color: #2c5282;
        }
        .spinner {
            border-top-color: #4299e1;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .tab-button {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .tab-button.active {
            background-color: #4a5568;
        }
        .tab-button:not(.active):hover {
            background-color: #2d3748;
        }
        .tab-content, .output-content {
            display: none;
        }
        .tab-content.active, .output-content.active {
            display: block;
        }
        .fade-in-section {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .fade-in-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
        .password-strength-bar {
            height: 4px;
            width: 0%;
            border-radius: 2px;
            transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }
         .qr-container {
            background: #1a202c;
            border-radius: 0.5rem;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>
<body class="bg-zinc-900 text-gray-200">

    <!-- QR Scanner Modal -->
    <div id="qr-scanner-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex-col items-center justify-center z-50 hidden p-4">
        <div class="w-full max-w-sm bg-white p-4 rounded-lg">
            <div id="qr-reader" class="w-full"></div>
        </div>
        <button id="close-scanner-button" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-semibold">Cancel</button>
    </div>

    <!-- Hero Section -->
    <section class="relative text-center py-24 md:py-32 lg:py-40 overflow-hidden hero-gradient">
        <div class="container mx-auto px-6">
            <div class="max-w-3xl mx-auto">
                <div class="inline-flex items-center gap-2 bg-blue-500/10 border border-blue-500/30 text-blue-300 rounded-full px-4 py-1 mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    <span>AES-256 Browser-Based Encryption</span>
                </div>
                <h1 class="text-4xl md:text-6xl font-extrabold text-white tracking-tighter mb-4">Share Files with Absolute Privacy.</h1>
                <p class="text-lg md:text-xl text-gray-400 max-w-2xl mx-auto mb-8">
                    CryptaShare encrypts your files directly in your browser. Share via a self-contained link or generate a short link with a QR code for easy mobile sharing.
                </p>
                <a href="#app" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-200 text-lg">
                    Start Sharing Securely
                </a>
            </div>
        </div>
    </section>

    <!-- How It Works Section -->
    <section class="py-20 md:py-28 bg-black fade-in-section">
        <div class="container mx-auto px-6">
            <div class="text-center max-w-2xl mx-auto mb-16">
                <h2 class="text-3xl md:text-4xl font-bold text-white">A Simpler, Safer Way to Share</h2>
                <p class="text-gray-400 mt-4">Our entire process is designed for maximum security and simplicity. Your files never leave your device until they are securely encrypted.</p>
            </div>
            <div class="grid md:grid-cols-3 gap-8 md:gap-12 text-center">
                <!-- Step 1 -->
                <div class="flex flex-col items-center">
                    <div class="flex items-center justify-center h-20 w-20 bg-blue-500/10 border border-blue-500/30 rounded-xl mb-6">
                         <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">1. Select a File</h3>
                    <p class="text-gray-400">Choose any file from your computer. It is immediately prepared for encryption without being uploaded.</p>
                </div>
                <!-- Step 2 -->
                <div class="flex flex-col items-center">
                    <div class="flex items-center justify-center h-20 w-20 bg-blue-500/10 border border-blue-500/30 rounded-xl mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">2. Encrypt & Link</h3>
                    <p class="text-gray-400">Set a password to encrypt the file in your browser. A secure, shareable link containing the encrypted data is instantly generated.</p>
                </div>
                <!-- Step 3 -->
                <div class="flex flex-col items-center">
                    <div class="flex items-center justify-center h-20 w-20 bg-blue-500/10 border border-blue-500/30 rounded-xl mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">3. Share Privately</h3>
                    <p class="text-gray-400">Send the link to your recipient. They can only decrypt and download the original file if you also provide them with the correct password.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- App Section -->
    <section id="app" class="py-20 md:py-28 bg-zinc-900">
        <div class="container mx-auto px-6">
            <div class="w-full max-w-4xl bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8 mx-auto">
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Encryption Section -->
                    <div id="encrypt-card" class="bg-gray-700/50 p-6 rounded-lg border border-gray-700">
                        <h2 class="text-2xl font-semibold mb-4 text-center text-blue-300">Encrypt File</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="encrypt-file-input" id="encrypt-file-label" class="file-input-label">
                                    <div class="text-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 text-gray-500"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                        <span id="encrypt-file-text" class="text-gray-400">Click or drag file to upload</span>
                                    </div>
                                </label>
                                <input type="file" id="encrypt-file-input" class="hidden">
                            </div>
                            <div>
                                <label for="encrypt-key" class="block text-sm font-medium text-gray-300 mb-1">Encryption Key (Password)</label>
                                <input type="password" id="encrypt-key" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter a strong password">
                                <div class="mt-2 flex items-center">
                                    <div class="w-full bg-gray-600 rounded-full h-1">
                                        <div id="password-strength-bar" class="password-strength-bar"></div>
                                    </div>
                                    <span id="password-strength-text" class="ml-3 text-xs font-medium text-gray-400 w-16 text-right"></span>
                                </div>
                            </div>
                            <div>
                                <label for="encrypt-key-confirm" class="block text-sm font-medium text-gray-300 mb-1">Confirm Key</label>
                                <input type="password" id="encrypt-key-confirm" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Re-enter your password">
                            </div>
                            <button id="encrypt-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-200 flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                Encrypt File
                            </button>
                        </div>
                        <div id="encrypt-status" class="mt-4 text-center"></div>
                        <div id="encrypt-result" class="mt-4 space-y-3 hidden">
                            <div class="flex bg-gray-800 rounded-md p-1">
                                <button id="show-link-button" class="tab-button active">Long Link</button>
                                <button id="show-qr-button" class="tab-button">QR Code / Short Link</button>
                            </div>
                            <div id="link-output" class="output-content active">
                                <label class="block text-sm font-medium text-gray-300">Shareable Link (Self-Contained):</label>
                                <textarea id="share-link-textarea" readonly class="w-full h-24 bg-gray-900 border border-gray-600 rounded-md p-2 text-xs text-gray-300 resize-none"></textarea>
                                <button id="copy-link-button" class="w-full mt-2 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition duration-200">Copy Link</button>
                            </div>
                            <div id="qr-output" class="output-content">
                                <div class="qr-container">
                                    <div class="bg-white p-2 rounded-md inline-block shadow-lg shadow-blue-500/20">
                                        <canvas id="qr-canvas"></canvas>
                                    </div>
                                    <div id="qr-status" class="text-xs text-blue-300 mt-4 text-center"></div>
                                    <div id="short-link-container" class="w-full mt-4 hidden">
                                        <input type="text" id="short-link-display" readonly class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-xs text-center text-gray-300">
                                        <button id="copy-short-link-button" class="w-full mt-2 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition duration-200">Copy Short Link</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Decryption Section -->
                    <div id="decrypt-card" class="bg-gray-700/50 p-6 rounded-lg border border-gray-700">
                        <h2 class="text-2xl font-semibold mb-4 text-center text-green-300">Decrypt File</h2>
                        <div class="flex bg-gray-800 rounded-md p-1 mb-4">
                            <button id="decrypt-tab-file" class="tab-button active">From File</button>
                            <button id="decrypt-tab-link" class="tab-button">From Link</button>
                        </div>
                        <div class="space-y-4">
                            <div id="decrypt-content-file" class="tab-content active">
                                <label for="decrypt-file-input" id="decrypt-file-label" class="file-input-label">
                                    <div class="text-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 text-gray-500"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                        <span id="decrypt-file-text" class="text-gray-400">Click or drag encrypted file</span>
                                    </div>
                                </label>
                                <input type="file" id="decrypt-file-input" class="hidden">
                            </div>
                            <div id="decrypt-content-link" class="tab-content">
                                <label for="decrypt-link-input" class="block text-sm font-medium text-gray-300 mb-1">Paste Shareable Link</label>
                                <textarea id="decrypt-link-input" class="w-full h-24 bg-gray-800 border border-gray-600 rounded-md p-2 text-xs text-gray-300 resize-y" placeholder="Paste the long link or short link here..."></textarea>
                                <button id="scan-qr-button" class="w-full mt-2 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition duration-200 flex items-center justify-center gap-2">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><rect x="7" y="7" width="10" height="10" rx="1"></rect></svg>
                                    Scan QR Code
                                </button>
                            </div>
                            <div>
                                <label for="decrypt-key" class="block text-sm font-medium text-gray-300 mb-1">Decryption Key (Password)</label>
                                <input type="password" id="decrypt-key" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Enter the password">
                            </div>
                            <button id="decrypt-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition duration-200 flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 11V7a5 5 0 0 1 9.9-1"></path><path d="M10.3 21H5a2 2 0 0 1-2-2V11a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v4.7"></path></svg>
                                Decrypt & Download
                            </button>
                        </div>
                        <div id="decrypt-status" class="mt-4 text-center"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- FAQ Section -->
    <section class="py-20 md:py-28 bg-black fade-in-section">
        <div class="container mx-auto px-6">
            <div class="text-center max-w-2xl mx-auto mb-16">
                <h2 class="text-3xl md:text-4xl font-bold text-white">Frequently Asked Questions</h2>
            </div>
            <div class="max-w-3xl mx-auto space-y-8">
                <div class="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
                    <h3 class="text-lg font-semibold text-white mb-2">Is this really secure?</h3>
                    <p class="text-gray-400">Yes. CryptaShare uses AES-256, a military-grade encryption standard. The entire encryption and decryption process happens locally in your web browser. Your private key (password) and your files are never sent to any server, ensuring complete privacy.</p>
                </div>
                <div class="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
                    <h3 class="text-lg font-semibold text-white mb-2">Where is my file stored?</h3>
                    <p class="text-gray-400">For "Long Links", your encrypted file data is encoded directly into the link itself. For "Short Links / QR Codes", the encrypted data is stored temporarily on a secure Supabase server. In both cases, we never see your unencrypted file or your password.</p>
                </div>
                <div class="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
                    <h3 class="text-lg font-semibold text-white mb-2">Is there a file size limit?</h3>
                    <p class="text-gray-400">For "Long Links", very large files (>100MB) can create URLs that are too long for some browsers. For "Short Links", the limit is much higher and depends on the backend service's free plan (usually several hundred MB).</p>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Footer -->
    <footer class="text-center py-10 border-t border-gray-800">
        <p class="text-gray-500">&copy; 2025 CryptaShare. All Rights Reserved.</p>
    </footer>

    <script>
        // --- DOM Elements ---
        const encryptFileInput = document.getElementById('encrypt-file-input');
        const encryptFileLabel = document.getElementById('encrypt-file-label');
        const encryptFileText = document.getElementById('encrypt-file-text');
        const encryptKeyInput = document.getElementById('encrypt-key');
        const encryptKeyConfirmInput = document.getElementById('encrypt-key-confirm');
        const encryptButton = document.getElementById('encrypt-button');
        const encryptStatus = document.getElementById('encrypt-status');
        const encryptResult = document.getElementById('encrypt-result');
        const showLinkButton = document.getElementById('show-link-button');
        const showQrButton = document.getElementById('show-qr-button');
        const linkOutput = document.getElementById('link-output');
        const qrOutput = document.getElementById('qr-output');
        const qrCanvas = document.getElementById('qr-canvas');
        const qrStatus = document.getElementById('qr-status');
        const shareLinkTextarea = document.getElementById('share-link-textarea');
        const copyLinkButton = document.getElementById('copy-link-button');
        const shortLinkContainer = document.getElementById('short-link-container');
        const shortLinkDisplay = document.getElementById('short-link-display');
        const copyShortLinkButton = document.getElementById('copy-short-link-button');
        const decryptTabFile = document.getElementById('decrypt-tab-file');
        const decryptTabLink = document.getElementById('decrypt-tab-link');
        const decryptContentFile = document.getElementById('decrypt-content-file');
        const decryptContentLink = document.getElementById('decrypt-content-link');
        const decryptFileInput = document.getElementById('decrypt-file-input');
        const decryptFileLabel = document.getElementById('decrypt-file-label');
        const decryptFileText = document.getElementById('decrypt-file-text');
        const decryptLinkInput = document.getElementById('decrypt-link-input');
        const decryptKeyInput = document.getElementById('decrypt-key');
        const decryptButton = document.getElementById('decrypt-button');
        const decryptStatus = document.getElementById('decrypt-status');
        const passwordStrengthBar = document.getElementById('password-strength-bar');
        const passwordStrengthText = document.getElementById('password-strength-text');
        const scanQrButton = document.getElementById('scan-qr-button');
        const qrScannerModal = document.getElementById('qr-scanner-modal');
        const closeScannerButton = document.getElementById('close-scanner-button');

        let encryptFile = null;
        let decryptFile = null;
        let currentDecryptMode = 'file';
        let generatedShortLink = null;
        let supabaseClient = null;
        let html5QrCode;

        // --- Supabase Configuration ---
        const supabaseUrl = 'https://dbfgplgvlydlpoawgoti.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRiZmdwbGd2bHlkbHBvYXdnb3RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2NDg4NjUsImV4cCI6MjA2OTIyNDg2NX0.44_XsWIc8UVim0i87jumIqbXG0GaJ3hEs_5zrEewvdw';

        if (supabaseUrl && supabaseAnonKey && window.supabase) {
            try {
                supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
            } catch (e) {
                console.error("Error initializing Supabase client:", e);
            }
        }

        // --- Core Crypto Functions ---
        function getKey(password, salt) {
            const enc = new TextEncoder();
            return window.crypto.subtle.importKey('raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveKey'])
                .then(baseKey => window.crypto.subtle.deriveKey({ name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' }, baseKey, { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']));
        }

        async function encryptPayload(data, password) {
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const key = await getKey(password, salt);
            const encryptedContent = await window.crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, data);
            const result = new Uint8Array(salt.length + iv.length + encryptedContent.byteLength);
            result.set(salt, 0);
            result.set(iv, salt.length);
            result.set(new Uint8Array(encryptedContent), salt.length + iv.length);
            return result.buffer;
        }

        async function decryptPayload(data, password) {
            const dataBytes = new Uint8Array(data);
            const salt = dataBytes.slice(0, 16);
            const iv = dataBytes.slice(16, 28);
            const encryptedContent = dataBytes.slice(28);
            const key = await getKey(password, salt);
            return await window.crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, encryptedContent);
        }

        // --- Utility Functions ---
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsArrayBuffer(file);
            });
        }

        function downloadBlob(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
        
        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const bytes = new Uint8Array(binary_string.length);
            for (let i = 0; i < binary_string.length; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function showStatus(element, message, type) {
            let colorClass = 'text-gray-400';
            if (type === 'success') colorClass = 'text-green-400';
            if (type === 'error') colorClass = 'text-red-400';
            let spinner = type === 'loading' ? `<div class="spinner h-5 w-5 border-4 rounded-full inline-block mr-2"></div>` : '';
            element.innerHTML = `<div class="flex items-center justify-center ${colorClass}">${spinner}<span>${message}</span></div>`;
        }
        
        // --- New Feature: Password Strength ---
        function checkPasswordStrength(password) {
            let score = 0;
            if (!password) {
                passwordStrengthBar.style.width = '0%';
                passwordStrengthText.textContent = '';
                return;
            }
            if (password.length >= 8) score++;
            if (password.length >= 12) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;

            if (score <= 2) {
                passwordStrengthBar.style.width = '33.3%';
                passwordStrengthBar.style.backgroundColor = '#ef4444';
                passwordStrengthText.textContent = 'Weak';
                passwordStrengthText.style.color = '#ef4444';
            } else if (score <= 4) {
                passwordStrengthBar.style.width = '66.6%';
                passwordStrengthBar.style.backgroundColor = '#f59e0b';
                passwordStrengthText.textContent = 'Medium';
                passwordStrengthText.style.color = '#f59e0b';
            } else {
                passwordStrengthBar.style.width = '100%';
                passwordStrengthBar.style.backgroundColor = '#22c55e';
                passwordStrengthText.textContent = 'Strong';
                passwordStrengthText.style.color = '#22c55e';
            }
        }

        encryptKeyInput.addEventListener('input', (e) => {
            checkPasswordStrength(e.target.value);
        });

        // --- New Feature: Scroll Animations ---
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.fade-in-section').forEach(section => {
            observer.observe(section);
        });

        // --- Event Listeners ---
        function handleFileSelection(file, textElement) {
             if (file) {
                textElement.textContent = file.name;
                textElement.classList.add('text-white');
            } else {
                textElement.textContent = textElement.id.includes('encrypt') ? 'Click or drag file to upload' : 'Click or drag file to decrypt';
                textElement.classList.remove('text-white');
            }
        }

        encryptFileInput.addEventListener('change', () => {
            encryptFile = encryptFileInput.files[0];
            handleFileSelection(encryptFile, encryptFileText);
            encryptResult.classList.add('hidden');
            generatedShortLink = null;
        });

        decryptFileInput.addEventListener('change', () => {
            decryptFile = decryptFileInput.files[0];
            handleFileSelection(decryptFile, decryptFileText);
        });

        function setupDragDrop(label, input, fileVarSetter, textElement) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => label.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
            ['dragenter', 'dragover'].forEach(ev => label.addEventListener(ev, () => label.classList.add('dragover')));
            ['dragleave', 'drop'].forEach(ev => label.addEventListener(ev, () => label.classList.remove('dragover')));
            label.addEventListener('drop', e => {
                input.files = e.dataTransfer.files;
                const file = input.files[0];
                fileVarSetter(file);
                handleFileSelection(file, textElement);
                if (input.id.includes('encrypt')) {
                    encryptResult.classList.add('hidden');
                    generatedShortLink = null;
                }
            });
        }

        setupDragDrop(encryptFileLabel, encryptFileInput, f => encryptFile = f, encryptFileText);
        setupDragDrop(decryptFileLabel, decryptFileInput, f => decryptFile = f, decryptFileText);

        encryptButton.addEventListener('click', async () => {
            if (!encryptFile || !encryptKeyInput.value) {
                showStatus(encryptStatus, 'Please select a file and enter a key.', 'error');
                return;
            }
            if (encryptKeyInput.value !== encryptKeyConfirmInput.value) {
                showStatus(encryptStatus, 'Passwords do not match. Please try again.', 'error');
                return;
            }

            encryptButton.disabled = true;
            encryptResult.classList.add('hidden');
            showStatus(encryptStatus, 'Encrypting, please wait...', 'loading');

            try {
                const fileNameBytes = new TextEncoder().encode(encryptFile.name);
                const fileBuffer = await readFileAsArrayBuffer(encryptFile);
                
                const payload = new Uint8Array(2 + fileNameBytes.length + fileBuffer.byteLength);
                new DataView(payload.buffer).setUint16(0, fileNameBytes.length, false);
                payload.set(fileNameBytes, 2);
                payload.set(new Uint8Array(fileBuffer), 2 + fileNameBytes.length);

                const encryptedBuffer = await encryptPayload(payload.buffer, encryptKeyInput.value);
                const base64Data = arrayBufferToBase64(encryptedBuffer);
                const dataUrl = `data:application/octet-stream;base64,${base64Data}`;
                
                shareLinkTextarea.value = dataUrl;
                encryptResult.classList.remove('hidden');
                showStatus(encryptStatus, 'File encrypted successfully!', 'success');
                showLinkButton.click();
            } catch (error) {
                console.error('Encryption failed:', error);
                showStatus(encryptStatus, 'Encryption failed. See console for details.', 'error');
            } finally {
                encryptButton.disabled = false;
            }
        });

        copyLinkButton.addEventListener('click', () => {
            shareLinkTextarea.select();
            document.execCommand('copy');
            copyLinkButton.textContent = "Copied!";
            setTimeout(() => {
                copyLinkButton.textContent = "Copy Link";
            }, 2000);
        });

        copyShortLinkButton.addEventListener('click', () => {
            shortLinkDisplay.select();
            document.execCommand('copy');
            copyShortLinkButton.textContent = "Copied!";
            setTimeout(() => {
                copyShortLinkButton.textContent = "Copy Short Link";
            }, 2000);
        });
        
        showLinkButton.addEventListener('click', () => {
            showLinkButton.classList.add('active');
            showQrButton.classList.remove('active');
            linkOutput.classList.add('active');
            qrOutput.classList.remove('active');
        });

        showQrButton.addEventListener('click', async () => {
            showQrButton.classList.add('active');
            showLinkButton.classList.remove('active');
            qrOutput.classList.add('active');
            linkOutput.classList.remove('active');

            if (!supabaseClient) {
                qrStatus.textContent = "Supabase not configured. Cannot create short link.";
                return;
            }

            if (generatedShortLink) {
                new QRious({ element: qrCanvas, value: generatedShortLink, size: 220, level: 'M' });
                qrStatus.textContent = "";
                shortLinkDisplay.value = generatedShortLink;
                shortLinkContainer.classList.remove('hidden');
                return;
            }

            const dataUrl = shareLinkTextarea.value;
            if (!dataUrl) return;

            qrStatus.innerHTML = '<div class="spinner h-5 w-5 border-4 rounded-full inline-block mr-2"></div><span>Uploading for QR...</span>';
            shortLinkContainer.classList.add('hidden');

            try {
                const base64Data = dataUrl.split(',')[1];
                const { data, error } = await supabaseClient
                    .from('encrypted_files')
                    .insert([{ data: base64Data }])
                    .select('id');

                if (error) throw error;
                
                const fileId = data[0].id;
                const link = new URL(window.location.origin + window.location.pathname);
                link.hash = fileId;
                generatedShortLink = link.href;

                new QRious({ element: qrCanvas, value: generatedShortLink, size: 220, level: 'M' });
                qrStatus.textContent = "";
                shortLinkDisplay.value = generatedShortLink;
                shortLinkContainer.classList.remove('hidden');

            } catch (error) {
                console.error("QR Code generation/upload failed:", error);
                if (error.code === '42501') { // RLS policy violation
                    qrStatus.innerHTML = `
                        <div class="text-red-400 text-xs text-left">
                            <p class="font-bold">Permission Error:</p>
                            <p>Your Supabase security rules are blocking new files. Please enable 'INSERT' access:</p>
                            <ol class="list-decimal list-inside mt-2">
                                <li>Go to your Supabase project > <b>Authentication</b> > <b>Policies</b>.</li>
                                <li>Select the 'encrypted_files' table.</li>
                                <li>Click <b>New Policy</b> > <b>Get started quickly</b>.</li>
                                <li>Select <b>"Enable insert for everyone"</b> and save the policy.</li>
                            </ol>
                        </div>
                    `;
                } else if (error.code === 'PGRST204') {
                    qrStatus.innerHTML = `
                        <div class="text-red-400 text-xs text-left">
                            <p class="font-bold">Database Error:</p>
                            <p>Could not find the 'data' column. Please check two things in your Supabase project:</p>
                            <ol class="list-decimal list-inside mt-2">
                                <li>In the <b>Table Editor</b>, ensure your 'encrypted_files' table has a column named 'data' of type 'text'.</li>
                                <li>Go to <b>Project Settings > API</b> and click "Reload" on the schema cache.</li>
                            </ol>
                        </div>
                    `;
                } else {
                    qrStatus.textContent = "Error creating short link.";
                }
            }
        });

        decryptTabFile.addEventListener('click', () => {
            currentDecryptMode = 'file';
            decryptTabFile.classList.add('active');
            decryptTabLink.classList.remove('active');
            decryptContentFile.classList.add('active');
            decryptContentLink.classList.remove('active');
        });

        decryptTabLink.addEventListener('click', () => {
            currentDecryptMode = 'link';
            decryptTabLink.classList.add('active');
            decryptTabFile.classList.remove('active');
            decryptContentLink.classList.add('active');
            decryptContentFile.classList.remove('active');
        });

        decryptButton.addEventListener('click', async () => {
            const password = decryptKeyInput.value;
            if (!password) {
                showStatus(decryptStatus, 'Please enter the decryption key.', 'error');
                return;
            }

            let encryptedBuffer;

            if (currentDecryptMode === 'file') {
                if (!decryptFile) {
                    showStatus(decryptStatus, 'Please select a file to decrypt.', 'error');
                    return;
                }
                encryptedBuffer = await readFileAsArrayBuffer(decryptFile);
            } else {
                const link = decryptLinkInput.value;
                if (!link) {
                    showStatus(decryptStatus, 'Please paste a shareable link.', 'error');
                    return;
                }
                
                if (link.includes('#')) {
                    if (!supabaseClient) {
                        showStatus(decryptStatus, "Supabase not configured. Cannot decrypt short link.", 'error');
                        return;
                    }
                    const fileId = link.split('#')[1];
                    showStatus(decryptStatus, 'Fetching short link data...', 'loading');
                    try {
                        const { data, error } = await supabaseClient
                            .from('encrypted_files')
                            .select('data')
                            .eq('id', fileId)
                            .single();
                        
                        if (error) throw error;

                        if (data) {
                            encryptedBuffer = base64ToArrayBuffer(data.data);
                        } else {
                            showStatus(decryptStatus, 'Error: Short link not found.', 'error');
                            return;
                        }
                    } catch (e) {
                        showStatus(decryptStatus, 'Error fetching from short link.', 'error');
                        return;
                    }
                } 
                else if (link.startsWith('data:application/octet-stream;base64,')) {
                    try {
                        const base64Data = link.split(',')[1];
                        encryptedBuffer = base64ToArrayBuffer(base64Data);
                    } catch (e) {
                        showStatus(decryptStatus, 'Invalid link data. Could not decode.', 'error');
                        return;
                    }
                } else {
                    showStatus(decryptStatus, 'Invalid link format.', 'error');
                    return;
                }
            }

            decryptButton.disabled = true;
            showStatus(decryptStatus, 'Decrypting, please wait...', 'loading');

            try {
                const decryptedPayload = await decryptPayload(encryptedBuffer, password);
                const view = new DataView(decryptedPayload);
                const fileNameLength = view.getUint16(0, false);
                const fileNameBytes = new Uint8Array(decryptedPayload, 2, fileNameLength);
                const originalFileName = new TextDecoder().decode(fileNameBytes);
                const fileContent = decryptedPayload.slice(2 + fileNameLength);

                const blob = new Blob([fileContent]);
                downloadBlob(blob, originalFileName);
                showStatus(decryptStatus, 'File decrypted and download started!', 'success');

            } catch (error) {
                console.error('Decryption failed:', error);
                showStatus(decryptStatus, 'Decryption failed. Incorrect password or corrupted data.', 'error');
            } finally {
                decryptButton.disabled = false;
            }
        });
        
        // Auto-fill link if present in URL
        window.addEventListener('load', () => {
            if (window.location.hash) {
                decryptLinkInput.value = window.location.href;
                decryptTabLink.click();
            }
        });

        // --- QR Scanner Logic ---
        scanQrButton.addEventListener('click', () => {
            qrScannerModal.style.display = 'flex';
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                stopScanner();
                decryptLinkInput.value = decodedText;
                showStatus(decryptStatus, 'QR Code Scanned! Enter password to decrypt.', 'success');
            };
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                .catch(err => {
                    console.error("QR Scanner failed to start.", err);
                    showStatus(decryptStatus, 'Could not start QR scanner.', 'error');
                    qrScannerModal.style.display = 'none';
                });
        });

        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    qrScannerModal.style.display = 'none';
                }).catch(err => {
                    console.error("Failed to stop QR scanner.", err);
                    qrScannerModal.style.display = 'none';
                });
            } else {
                qrScannerModal.style.display = 'none';
            }
        }

        closeScannerButton.addEventListener('click', stopScanner);
    </script>
</body>
</html>
